<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Application of mELO ratings to AFL matches • mELO</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Application of mELO ratings to AFL matches">
<meta property="og:description" content="mELO">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mELO</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01_introduction.html">Introduction to mELO ratings</a>
    </li>
    <li>
      <a href="../articles/02_afl.html">Application of mELO ratings to AFL matches</a>
    </li>
    <li>
      <a href="../articles/03_noise.html">Impact of noisy or probabilistic outcomes in mELO models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/dclaz/mELO/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Application of mELO ratings to AFL matches</h1>
                        <h4 class="author">David Lazaridis</h4>
            
            <h4 class="date">2020-05-16</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/dclaz/mELO/blob/master/vignettes/02_afl.Rmd"><code>vignettes/02_afl.Rmd</code></a></small>
      <div class="hidden name"><code>02_afl.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>As demonstrated in the <a href="01_introduction.html">introductory vignette</a>, Elo and other methods that rely on a single parameter that describe an agents ability cannot accomodate scenarios with cyclical or non-transitive interactions amongst agents or players. In situations where these behaviours are expected, a mELO model is likely to achieve far better results than an Elo model provided the outcomes aren’t too noisy and the agents abilities are locally stationary.</p>
<p><strong>Note:</strong> <strong>Stationarity is important</strong>. If agents <em>true</em> abilities change too fast, statistical methods are not likely to yield useful estimates or predictions.</p>
<p>In this document we will use the <strong>mELO</strong> package to see if a mELO model can outperform a regular Elo model for the task of predicting the outcome of <a href="https://en.wikipedia.org/wiki/Australian_Football_League">AFL</a> matches. We do not expect the performance of the mELO model to be amazing. Other methods for predicting match outcomes that are more highly parameterised (such as <em>Glicko</em> or <em>Steph</em> as implemented in the <a href="https://cran.r-project.org/package=PlayerRatings">PlayerRating</a> package) or are able to make predictions conditional on additional information (other statistical or machine learning methods) would likely yield better results.</p>
</div>
<div id="method" class="section level1">
<h1 class="hasAnchor">
<a href="#method" class="anchor"></a>Method</h1>
<p>We will apply the following procedure to build models and assess their performance:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Split data in to the following segments</strong>
<ul>
<li>
<strong>Initialisation data</strong>. Seasons 2012–2014 inclusive.</li>
<li>
<strong>Training data</strong>. Seasons 2015–2018 inclusive.</li>
<li>
<strong>Test data</strong>. Seasons 2019–2020.</li>
</ul>
</li>
<li>
<strong>Model fitting</strong>
<ul>
<li>Select hyperparamters: learning rates &amp; home ground advantage.</li>
<li>Fit model to initialisation data</li>
<li>Fit model to training data, initialised with the estimates obtained from the initialised model.</li>
</ul>
</li>
<li>
<strong>Model optimisation</strong>
<ul>
<li>Repeat step 2 to find hyperparamters that minimises the chosen loss f unction on the training data.</li>
</ul>
</li>
<li>
<strong>Get final estimate of model error</strong>
<ul>
<li>Using the optimal model from step 3, calculate error on the test data.</li>
</ul>
</li>
</ol>
<p>The initialisation step is necessary because the initial ratings for all agents will be set to the same value and the <span class="math inline">\(\textbf{C}\)</span> matrix will have been initialised randomly. The first segment of the AFL match data is used to initialise the model so that reasonable estimates of <span class="math inline">\(\textbf{r}\)</span> and <span class="math inline">\(\textbf{C}\)</span> can be obtained and plugged in to the training model before we start calculating estimated model errors.</p>
<p>The outcomes we are modelling will be <span class="math inline">\(y \in \{0, 0.5, 1\}\)</span> representing a loss, draw and win respectively.</p>
<p>We will use the logarithmic loss function (equivalent to cross-entropy in this setting) to evaluate model fits, calculated as <span class="math display">\[ \mathcal{L(\Theta)} = - \frac{1}{n} \sum_{i=1}^n [y_{i} \log \, p_{i} + (1 - y_{i}) \log \, (1 - p_{i})].\]</span> where <span class="math inline">\(i\)</span> is the match index, <span class="math inline">\(n\)</span> is the total number of matches we are calculating the loss over and <span class="math inline">\(\Theta\)</span> is the set of model hyperparamters.</p>
<p><strong>Note:</strong> Alternatively for step 2, because these are iterative procedures we can fit a model with the specified hyperparameters to the initialisation data + training data, and then in step 3 we only count the errors from the training data portion.</p>
</div>
<div id="the-data" class="section level1">
<h1 class="hasAnchor">
<a href="#the-data" class="anchor"></a>The data</h1>
<p>A large sample of AFL match data has been sourced using the excellent <a href="https://cran.r-project.org/package=fitzRoy">fitzRoy</a> package and made available in the <code>afl_df</code> object.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co"># Load essential packages</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">mELO</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)

<span class="co"># Inspect AFL match data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">afl_df</span>) <span class="kw">%&gt;%</span> <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>()</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="right">match_index</th>
<th align="left">home_team</th>
<th align="left">away_team</th>
<th align="right">outcome</th>
<th align="left">date</th>
<th align="right">home_score</th>
<th align="right">away_score</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">Richmond</td>
<td align="left">Melbourne</td>
<td align="right">1</td>
<td align="left">2000-03-08</td>
<td align="right">94</td>
<td align="right">92</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">Essendon</td>
<td align="left">Port Adelaide</td>
<td align="right">1</td>
<td align="left">2000-03-09</td>
<td align="right">156</td>
<td align="right">62</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="left">North Melbourne</td>
<td align="left">West Coast</td>
<td align="right">0</td>
<td align="left">2000-03-10</td>
<td align="right">111</td>
<td align="right">154</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="left">Adelaide</td>
<td align="left">Footscray</td>
<td align="right">0</td>
<td align="left">2000-03-11</td>
<td align="right">108</td>
<td align="right">131</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="left">Fremantle</td>
<td align="left">Geelong</td>
<td align="right">0</td>
<td align="left">2000-03-11</td>
<td align="right">107</td>
<td align="right">129</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="left">St Kilda</td>
<td align="left">Sydney</td>
<td align="right">0</td>
<td align="left">2000-03-12</td>
<td align="right">100</td>
<td align="right">134</td>
</tr>
</tbody>
</table>
<p>Split the data in to the required segments</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co"># Initialisation data</span>
<span class="no">init_df</span> <span class="kw">&lt;-</span> <span class="no">afl_df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(
    <span class="no">date</span> <span class="kw">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2012-01-01"</span>),
    <span class="no">date</span> <span class="kw">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2015-01-01"</span>)
  ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">match_index</span>, <span class="no">home_team</span>, <span class="no">away_team</span>, <span class="no">outcome</span>)

<span class="co"># Training data</span>
<span class="no">train_df</span> <span class="kw">&lt;-</span> <span class="no">afl_df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(
    <span class="no">date</span> <span class="kw">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2015-01-01"</span>),
    <span class="no">date</span> <span class="kw">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2018-01-01"</span>)
  ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">match_index</span>, <span class="no">home_team</span>, <span class="no">away_team</span>, <span class="no">outcome</span>)

<span class="co"># Test data</span>
<span class="no">test_df</span> <span class="kw">&lt;-</span> <span class="no">afl_df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(
    <span class="no">date</span> <span class="kw">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2018-01-01"</span>),
    <span class="no">date</span> <span class="kw">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"2020-01-01"</span>)
  ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">match_index</span>, <span class="no">home_team</span>, <span class="no">away_team</span>, <span class="no">outcome</span>)

<span class="co"># Combine init and train for convenience (See note above)</span>
<span class="no">init_train_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(
  <span class="no">init_df</span>,
  <span class="no">train_df</span>
)

<span class="co"># How many games in each data set</span>
<span class="no">n_init</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">init_df</span>)
<span class="no">n_train</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">train_df</span>)
<span class="no">n_test</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">test_df</span>)</pre></body></html></div>
</div>
<div id="the-models" class="section level1">
<h1 class="hasAnchor">
<a href="#the-models" class="anchor"></a>The models</h1>
<p>For the sake of simplicity we will apply the homeground advantage to all teams playing at home. A more rigorous experiment would be to identify in which matches the away team had a travel disadvantage, and then set the home team to have an advantage in that match.</p>
<div id="elo" class="section level2">
<h2 class="hasAnchor">
<a href="#elo" class="anchor"></a>ELO</h2>
<p>We begin by writing a function to help us perform step 2. This function returns the logloss over the training data for an Elo model fit with the specified hyperparameters, <span class="math inline">\(\Theta = (\eta, \gamma)\)</span>, the learning rate and home ground advantage respectively.</p>
<p><strong>Note:</strong> The <code><a href="../reference/ELO.html">ELO()</a></code> and <code><a href="../reference/mELO.html">mELO()</a></code> functions return the true outcomes and the predictions for time <span class="math inline">\(t+1\)</span> made at time <span class="math inline">\(t\)</span> which make the loss calculations straightforward and removes the requirement to write a function to loop through matches.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co"># Function to return logloss for current selection of hyperparameters</span>
<span class="no">ELO_logloss_error</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(
  <span class="no">hyperparams</span>
){
  <span class="co"># Fit model to INIT + TRAIN data</span>
  <span class="no">model</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/ELO.html">ELO</a></span>(
    <span class="no">init_train_df</span>,
    <span class="kw">eta</span> <span class="kw">=</span> <span class="no">hyperparams</span>[<span class="fl">1</span>],          <span class="co"># \eta</span>
    <span class="kw">p1_advantage</span> <span class="kw">=</span> <span class="no">hyperparams</span>[<span class="fl">2</span>], <span class="co"># \gamma</span>
    <span class="kw">save_history</span> <span class="kw">=</span> <span class="fl">FALSE</span>
  )

  <span class="co"># Calculate loss on the TRAIN data</span>
  <span class="co"># Note these predictions are made before the ratings are updated </span>
  <span class="no">train_logloss</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/logloss.html">logloss</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(<span class="no">model</span>$<span class="no">preds</span>, <span class="no">n_train</span>),
    <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(<span class="no">model</span>$<span class="no">outcomes</span>, <span class="no">n_train</span>)
  )

  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">train_logloss</span>)
}</pre></body></html></div>
<p>Now we can use an optimisation procedure to find the hyperparameters <span class="math inline">\(\Theta\)</span> such that the logloss error is minimised.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co"># Optimisation (assuming it's smooth)</span>
<span class="no">ELO_best_params</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">30</span>,<span class="fl">100</span>),
  <span class="no">ELO_logloss_error</span>,
  <span class="kw">method</span> <span class="kw">=</span> <span class="st">"BFGS"</span>

)

<span class="no">ELO_best_params</span>
<span class="co">#&gt; $par</span>
<span class="co">#&gt; [1] 45.87521 78.29343</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $value</span>
<span class="co">#&gt; [1] 0.6118559</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $counts</span>
<span class="co">#&gt; function gradient </span>
<span class="co">#&gt;       11        9 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $convergence</span>
<span class="co">#&gt; [1] 0</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $message</span>
<span class="co">#&gt; NULL</span></pre></body></html></div>
<p>The best model is obtained when <span class="math inline">\(\eta=\)</span> 45.88 and <span class="math inline">\(\gamma=\)</span> 78.29 (where the logarithmic loss <span class="math inline">\(\mathcal{L}=\)</span> 0.61). Now we can fit a model with these parameters and calculate the error on the test set.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co"># Fit model with optimal hyperparams</span>
<span class="no">optim_ELO_model</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/ELO.html">ELO</a></span>(
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(
    <span class="no">init_train_df</span>,
    <span class="no">test_df</span>
  ),
  <span class="kw">eta</span> <span class="kw">=</span> <span class="no">ELO_best_params</span>$<span class="no">par</span>[<span class="fl">1</span>],          <span class="co"># \eta</span>
  <span class="kw">p1_advantage</span> <span class="kw">=</span> <span class="no">ELO_best_params</span>$<span class="no">par</span>[<span class="fl">2</span>], <span class="co"># \gamma</span>
)

<span class="co"># Generate predictions on test set</span>
<span class="no">test_preds_ELO</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(<span class="no">optim_ELO_model</span>$<span class="no">preds</span>, <span class="no">n_test</span>)

<span class="co"># Calculate logloss error on test set</span>
<span class="no">test_logloss_ELO</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/logloss.html">logloss</a></span>(
  <span class="no">test_preds_ELO</span>,
  <span class="no">test_df</span>$<span class="no">outcome</span>
)

<span class="co"># Calculate classification rate on test set</span>
<span class="no">test_class_rate_ELO</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(
  (<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">test_preds_ELO</span> <span class="kw">&gt;=</span> <span class="fl">0.5</span>) <span class="kw">&amp;</span> <span class="no">test_df</span>$<span class="no">outcome</span> <span class="kw">==</span> <span class="fl">1</span>) <span class="kw">|</span>
    (<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">test_preds_ELO</span> <span class="kw">&lt;</span> <span class="fl">0.5</span>) <span class="kw">&amp;</span> <span class="no">test_df</span>$<span class="no">outcome</span> <span class="kw">==</span> <span class="fl">0</span>)
)</pre></body></html></div>
<p>Results:</p>
<ul>
<li>Test logloss <span class="math inline">\(\mathcal{L}=\)</span> 0.6176086.</li>
<li>Test classification rate = 67.6%.</li>
</ul>
<p>The figure below gives the evolutions of the Elo ratings. The vertical lines indicate the cut offs of the initialisation, training and test sets.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">optim_ELO_model</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">v</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">n_init</span>, <span class="no">n_init</span>+<span class="no">n_train</span>), <span class="kw">lty</span><span class="kw">=</span><span class="fl">2</span>)</pre></body></html></div>
<p><img src="02_afl_files/figure-html/ELO_plot-1.png" width="700"></p>
</div>
<div id="melo" class="section level2">
<h2 class="hasAnchor">
<a href="#melo" class="anchor"></a>mELO</h2>
<p>Similarly to the Elo model, we build a function to help us optimise the loss function.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># Function to return logloss for current selection of hyperparameters</span>
<span class="co"># k = 1</span>
<span class="no">mELO_logloss_error</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(
  <span class="no">hyperparams</span>
){
  <span class="co"># Set seed, C matrix is initialised randomly</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1337</span>)

  <span class="co"># Fit model to INIT + TRAIN data</span>
  <span class="no">model</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/mELO.html">mELO</a></span>(
    <span class="no">init_train_df</span>,
    <span class="co"># init_c_mat = matrix(</span>
    <span class="co">#   runif(2*1*18, -5, 5),</span>
    <span class="co">#   ncol = 2,</span>
    <span class="co">#   nrow = 18</span>
    <span class="co"># ),</span>
    <span class="kw">k</span> <span class="kw">=</span> <span class="fl">1</span>,
    <span class="kw">eta_1</span> <span class="kw">=</span> <span class="no">hyperparams</span>[<span class="fl">1</span>],          <span class="co"># \eta_1</span>
    <span class="kw">eta_2</span> <span class="kw">=</span> <span class="no">hyperparams</span>[<span class="fl">2</span>],          <span class="co"># \eta_2</span>
    <span class="kw">p1_advantage</span> <span class="kw">=</span> <span class="no">hyperparams</span>[<span class="fl">3</span>],   <span class="co"># \gamma</span>
    <span class="kw">save_history</span> <span class="kw">=</span> <span class="fl">FALSE</span>
  )

  <span class="co"># Calculate loss on the TRAIN data</span>
  <span class="co"># Note these predictions are made before the ratings are updated </span>
  <span class="no">train_logloss</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/logloss.html">logloss</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(<span class="no">model</span>$<span class="no">preds</span>, <span class="no">n_train</span>),
    <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(<span class="no">model</span>$<span class="no">outcomes</span>, <span class="no">n_train</span>)
  )

  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">train_logloss</span>)
}</pre></body></html></div>
<p>Now we can use an optimisation procedure to find the hyperparameters <span class="math inline">\(\Theta\)</span> such that the logloss error is minimised.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="co"># Optimisation (assuming the surface is reasonably well behaved)</span>
<span class="no">mELO_best_params</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html">optim</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">30</span>, <span class="fl">0.2</span>, <span class="fl">75</span>),
  <span class="no">mELO_logloss_error</span>,
  <span class="kw">method</span> <span class="kw">=</span> <span class="st">"L-BFGS-B"</span>,
  <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.1</span>, <span class="fl">0.01</span>, <span class="fl">40</span>),
  <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">100</span>,  <span class="fl">2</span>,    <span class="fl">120</span>)
)

<span class="no">mELO_best_params</span>
<span class="co">#&gt; $par</span>
<span class="co">#&gt; [1] 46.5037011  0.1040814 75.1288796</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $value</span>
<span class="co">#&gt; [1] 0.6142201</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $counts</span>
<span class="co">#&gt; function gradient </span>
<span class="co">#&gt;       19       19 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $convergence</span>
<span class="co">#&gt; [1] 0</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $message</span>
<span class="co">#&gt; [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"</span></pre></body></html></div>
<p>The best model is obtained when <span class="math inline">\(\eta_1=\)</span> 46.5, <span class="math inline">\(\eta_2=\)</span> 0.1 and <span class="math inline">\(\gamma=\)</span> 75.13 (where the logarithmic loss <span class="math inline">\(\mathcal{L}=\)</span> 0.61). Now we can fit a model with these parameters and calculate the error on the test set.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="co"># Fit model with optimal hyperparams</span>
<span class="co"># and same seed</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1337</span>)

<span class="no">optim_mELO_model</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/mELO.html">mELO</a></span>(
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(
    <span class="no">init_train_df</span>,
    <span class="no">test_df</span>
  ),
  <span class="kw">k</span> <span class="kw">=</span> <span class="fl">1</span>,
  <span class="kw">eta_1</span> <span class="kw">=</span> <span class="no">mELO_best_params</span>$<span class="no">par</span>[<span class="fl">1</span>],
  <span class="kw">eta_2</span> <span class="kw">=</span> <span class="no">mELO_best_params</span>$<span class="no">par</span>[<span class="fl">2</span>],
  <span class="kw">p1_advantage</span> <span class="kw">=</span> <span class="no">mELO_best_params</span>$<span class="no">par</span>[<span class="fl">3</span>],
)

<span class="co"># Generate predictions on test set</span>
<span class="no">test_preds_mELO</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(<span class="no">optim_mELO_model</span>$<span class="no">preds</span>, <span class="no">n_test</span>)

<span class="co"># Calculate logloss error on test set</span>
<span class="no">test_logloss_mELO</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/logloss.html">logloss</a></span>(
  <span class="no">test_preds_mELO</span>,
  <span class="no">test_df</span>$<span class="no">outcome</span>
)

<span class="co"># Calculate classification rate on test set</span>
<span class="no">test_class_rate_mELO</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(
  (<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">test_preds_mELO</span> <span class="kw">&gt;=</span> <span class="fl">0.5</span>) <span class="kw">&amp;</span> <span class="no">test_df</span>$<span class="no">outcome</span> <span class="kw">==</span> <span class="fl">1</span>) <span class="kw">|</span>
    (<span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">test_preds_mELO</span> <span class="kw">&lt;</span> <span class="fl">0.5</span>) <span class="kw">&amp;</span> <span class="no">test_df</span>$<span class="no">outcome</span> <span class="kw">==</span> <span class="fl">0</span>)
)</pre></body></html></div>
<p>Results:</p>
<ul>
<li>logloss <span class="math inline">\(\mathcal{L}=\)</span> 0.6253702.</li>
<li>Classification rate = 65.5%.</li>
</ul>
<p>The figure below gives the evoltions of the mELO ratings, they are very similar to the Elo paths. The vertical lines indicate the cut offs of the initialisation, training and test sets.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">optim_mELO_model</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">v</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">n_init</span>, <span class="no">n_init</span>+<span class="no">n_train</span>), <span class="kw">lty</span><span class="kw">=</span><span class="fl">2</span>)</pre></body></html></div>
<p><img src="02_afl_files/figure-html/mELO_plot-1.png" width="700"></p>
<p>We can also inspect the advantage matrix and plot the <span class="math inline">\(\textbf{c}\)</span> vectors for each team.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="co"># Get adv matrix</span>
<span class="no">adv_mat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/get_adv_mat.html">get_adv_mat</a></span>(<span class="no">optim_mELO_model</span>)

<span class="co"># Plot a cool heatmap</span>
<span class="co"># might give us an idea how 'similar' teams play styles are maybe?</span>
<span class="fu"><a href="https://rdrr.io/r/stats/heatmap.html">heatmap</a></span>(
  <span class="no">adv_mat</span>,
  <span class="kw">scale</span> <span class="kw">=</span> <span class="st">"none"</span>,
  <span class="kw">col</span> <span class="kw">=</span> <span class="kw pkg">viridisLite</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/viridisLite/man/viridis.html">viridis</a></span>(<span class="fl">256</span>)
)

<span class="co"># Plot c vectors for each team</span>
<span class="fu"><a href="../reference/plot_c_mat.html">plot_c_mat</a></span>(<span class="no">optim_mELO_model</span>)</pre></body></html></div>
<p><img src="02_afl_files/figure-html/mELO_plot_2-1.png" width="700"><img src="02_afl_files/figure-html/mELO_plot_2-2.png" width="700"></p>
</div>
</div>
<div id="conclusion" class="section level1">
<h1 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h1>
<p>Let’s gather our results</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">results_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">model</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Elo"</span>, <span class="st">"mELO"</span>),
  <span class="kw">`Test logloss`</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">test_logloss_ELO</span>, <span class="no">test_logloss_mELO</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fl">3</span>),
  <span class="kw">`Test Accuracy`</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(
    (<span class="fl">100</span>*<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">test_class_rate_ELO</span>, <span class="no">test_class_rate_mELO</span>)) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fl">1</span>), <span class="st">"%"</span>
  )
)

<span class="no">results_df</span> <span class="kw">%&gt;%</span> <span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>()</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="left">model</th>
<th align="right">Test.logloss</th>
<th align="left">Test.Accuracy</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Elo</td>
<td align="right">0.618</td>
<td align="left">67.6%</td>
</tr>
<tr class="even">
<td align="left">mELO</td>
<td align="right">0.625</td>
<td align="left">65.5%</td>
</tr>
</tbody>
</table>
<p>Based on the results in the table above, a mELO model (with <span class="math inline">\(k=1\)</span>) is inferior to the Elo model for predicting the outcome of AFL matches in the test set spanning seasons 2018–2019 as measured by both logloss and accuracy (classification rate) metrics.</p>
<p>If one was interested, there are a number of things to try to improve performance, including but not limited to:</p>
<ul>
<li>Improving the home ground advantage indicator.</li>
<li>Replace the <span class="math inline">\(\{0, 0.5, 1\}\)</span> outcome with a value that is some function of the match margin.</li>
<li>Find an improved initialisation of the <span class="math inline">\(\textbf{C}\)</span> matrix.</li>
</ul>
<p>Interestingly, the mELO model obtains inferior performance even on the training data. Adjusting the base team ratings with the <span class="math inline">\(\textbf{A}\)</span> matrix when making predictions hurts performance if the <span class="math inline">\(\textbf{c}\)</span> cannot be learned properly.</p>
<p>If we look at the <span class="math inline">\(\textbf{c}\)</span> vector plots for the rock-paper-scissors-fire-water example in the <a href="01_introduction.html#rock-paper-scissors-fire-water">introductory vignette</a>, we observe that even in that much simpler game, with fewer teams and no noise in the outcomes, it still takes ~75 mathes before the <span class="math inline">\(\textbf{c}\)</span> stablise and the predictions become accurate and we can be confident that the dynamics of the game have been captured. In contract, the AFL match data is far noisier<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>, with far fewer reptitions of matches and where we actually expect the <em>true ability</em> of teams to actually change in time due to changes to rosters, coaching and other factors.</p>
<p>For the AFL data, we suspect that the <span class="math inline">\(\textbf{c}\)</span> vectors cannot be learned adequately as they cannot keep up with the noisy dynamics of the environment and thus the resulting adjustments to predictions only hurt performance. If the learning rate (<span class="math inline">\(\eta_2\)</span>) is too low, the model won’t learn much about the current regime before it changes, if it is too high, it will overfit to the most recent matches.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>In the sense that two teams could play twice and results of the two matches could be very different. This doesn’t happer in rock-scissors-paper and its variants. The impact of noise in outcomes for mELO models is explored in the <a href="03_noise.html">this vignette</a>.<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by David Lazaridis.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
